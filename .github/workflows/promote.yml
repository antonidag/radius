name: Promote Integration

on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        options: [test, prod]
      version_tag:
        description: 'Full release tag, e.g. v-int2001-<sha>'
        required: true

permissions:
  contents: write  # Needed for git push and gh release edit

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download release artifact
        uses: robinraju/release-downloader@v1.12
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.event.inputs.version_tag }}
          fileName: integration.zip
          out-file-path: ./integration_artifact
          extract: true
          token: ${{ secrets.GITHUB_TOKEN }}

#      - name: Deploy Integration
#        uses: ./.github/workflows/deploy.yml
#        with:
#          environment: ${{ github.event.inputs.environment }}
#          version_tag: ${{ github.event.inputs.version_tag }}
#          integration_path: ./integration_artifact

      - name: Append to deployment audit file
        run: |
          mkdir -p .audit
          VERSION_TAG="${{ github.event.inputs.version_tag }}"
          INTEGRATION_ID=$(echo "$VERSION_TAG" | sed 's/^v-//' | cut -d '-' -f 1)
          AUDIT_FILE=".audit/${INTEGRATION_ID}.yml"
          timestamp=$(date +'%Y-%m-%d %H:%M:%S')

          NEW_ENTRY="- env: \"${{ github.event.inputs.environment }}\"
            tag: \"$VERSION_TAG\"
            deployed_at: \"$timestamp\"
            by: \"@${{ github.actor }}\""

          if [ -f "$AUDIT_FILE" ]; then
            echo -e "$NEW_ENTRY\n$(cat $AUDIT_FILE)" > "$AUDIT_FILE"
          else
            echo -e "$NEW_ENTRY" > "$AUDIT_FILE"
          fi

          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git fetch
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}
          git add "$AUDIT_FILE"
          git commit -m "Prepend deployment of $INTEGRATION_ID to ${{ github.event.inputs.environment }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check GitHub CLI is available
        run: gh --version

      - name: Append environment info to GitHub release
        run: |
          current_body=$(gh release view ${{ github.event.inputs.version_tag }} --json body -q ".body")
          timestamp=$(date +'%Y-%m-%d %H:%M:%S')
          updated_body=$(
          cat <<EOF
          âœ… Deployed to: ${{ github.event.inputs.environment }} at ${timestamp} by @${{ github.actor }}

          ${current_body}
          EOF
          )
          gh release edit ${{ github.event.inputs.version_tag }} --notes "$updated_body"
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

